<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, initial-scale=1" />
    <title>Estado del Despegue</title>

    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            padding: 20px;
            max-width: 700px;
            margin: auto;
        }
        h1 { 
            font-size: 1.6em; 
            margin-bottom: 8px;
        }

        .status {
            font-size: 2rem;
            font-weight: 700;
            padding: 16px 20px;
            border-radius: 10px;
            display: inline-block;
            background: #eee;
            color: #444;
        }
        .open { background:#00d46b; color:#093b1a; }
        .closed { background:#ff4747; color:#4f0000; }
        .unknown { background:#f0f0f0; color:#333; }

        .meta { 
            margin-top:10px;
            color:#666;
            font-size:0.95rem;
        }
    </style>
</head>

<body>
    <h1>Estado del despegue</h1>

    <div id="box" class="status unknown">Cargando…</div>
    <div id="meta" class="meta">Última actualización: —</div>


<script>
/* CONFIGURACIÓN */
const SHEET_ID = "1ZJ4mVkXZyUVBRXLeiSHI2gSOt7JdcYj92bfKtPujU3g";  // <-- TU HOJA
const GID = 0;   // pestaña ESTADO (gid=0)

/* ----------------------------------------------------------
   FUNCIÓN ROBUSTA PARA EXTRAER JSON DE GVIZ
----------------------------------------------------------- */
async function fetchFromGviz(id){
    const url = `https://docs.google.com/spreadsheets/d/${id}/gviz/tq?gid=${GID}&tqx=out:json`;
    const res = await fetch(url, {cache:"no-store"});
    if(!res.ok) throw new Error("Error GViz HTTP " + res.status);

    const text = await res.text();

    // 1) Buscar setResponse( … )
    let match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?/);

    let jsonCandidate = null;

    if (match && match[1]) {
        let frag = match[1];
        let start = frag.indexOf("{");
        if (start === -1) throw new Error("No se encontró JSON dentro de setResponse()");
        
        // Balancear llaves
        let depth = 0, end = -1;
        for (let i = start; i < frag.length; i++) {
            if (frag[i] === "{") depth++;
            else if (frag[i] === "}") {
                depth--;
                if (depth === 0) { end = i; break; }
            }
        }
        if (end === -1) throw new Error("JSON no está balanceado dentro de setResponse()");
        jsonCandidate = frag.slice(start, end+1);
    } else {
        // Fallback global
        let start = text.indexOf("{");
        if (start === -1) throw new Error("No se encontró ninguna llave { ");

        let depth = 0, end = -1;
        for (let i = start; i < text.length; i++){
            if (text[i] === "{") depth++;
            else if (text[i] === "}"){
                depth--;
                if (depth === 0) { end = i; break; }
            }
        }
        if (end === -1) throw new Error("JSON no balanceado en todo el documento");
        jsonCandidate = text.slice(start, end+1);
    }

    let json;
    try {
        json = JSON.parse(jsonCandidate);
    } catch (e) {
        console.error("JSON.parse falló:", e);
        console.error("Fragmento problemático:", jsonCandidate.substring(0,400));
        throw new Error("No se pudo interpretar el JSON de GViz");
    }

    const rows = json.table?.rows ?? [];
    if (rows.length === 0) throw new Error("No hay filas en la hoja");

    const value = rows[0].c?.[0]?.v ?? "";
    return String(value).trim();
}

/* ----------------------------------------------------------
   MOSTRAR EL ESTADO
----------------------------------------------------------- */
async function fetchEstado(){
    const box = document.getElementById("box");
    const meta = document.getElementById("meta");

    try {
        const estado = await fetchFromGviz(SHEET_ID);

        if (estado.toUpperCase().includes("ABIERTO")) {
            box.className = "status open";
        } else if (estado.toUpperCase().includes("CERRADO")) {
            box.className = "status closed";
        } else {
            box.className = "status unknown";
        }

        box.textContent = estado;
        meta.textContent = "Última actualización: " + new Date().toLocaleString("es-ES");

    } catch (err) {
        console.error("fetchEstado error:", err);
        box.className = "status unknown";
        box.textContent = "Error al obtener datos";
        meta.textContent = "Última actualización: " + new Date().toLocaleString("es-ES");
    }
}

fetchEstado();
setInterval(fetchEstado, 60000); // refresca cada 60s
</script>

</body>
</html>
